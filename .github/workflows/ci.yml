name: Metro Agent CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # ⚠️ 此时 01 已是普通文件夹，必须带上路径
        pip install -r 01/requirements.txt

    - name: Run Tests with pytest
      env: 
        # ⚠️ 直接指向工作区根目录，不要再加额外的 /01
        PYTHONPATH: ${{ github.workspace }}/01
        DEEPSEEK_API_KEY: "sk-dummy-key"
        DEEPSEEK_BASE_URL: "https://api.deepseek.com"
      run: |
        # 运行测试 (假设 tests 文件夹也在 01 里？还是在根目录？)
        # 如果 tests 在根目录：
        python -m pytest tests/
        # 如果 tests 也在 01 里，请改为： python -m pytest 01/tests/

  build_image:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker Image
      run: |
        # ⚠️ 进入 01 目录构建，因为 Dockerfile 在那里
        cd 01
        docker build -t metro-agent:ci-test .